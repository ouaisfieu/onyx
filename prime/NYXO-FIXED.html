<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="color-scheme" content="dark light"/>
<title>NYXO ‚Ä¢ Portail Collaboratif Sant√© Mentale Bruxelles</title>
<meta name="description" content="Portail open data collaboratif pour la sant√© mentale √† Bruxelles. Cartographie des lieux de liens, services, r√©seaux.">
<style>
:root{
  --bg0:#05070b; --bg1:#070c12;
  --txt:#eaf1ff; --mut:rgba(234,241,255,.66);
  --good:#86fbd6; --lilac:#d7a8ff; --warn:#ffd36a; --bad:#ff6a8b;
  --glass: blur(14px) saturate(140%);
  --shadow: 0 18px 60px rgba(0,0,0,.55);
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{
  font-family:var(--sans);color:var(--txt);
  background:
    radial-gradient(900px 600px at 15% 10%, rgba(134,251,214,.14), transparent 60%),
    radial-gradient(900px 600px at 85% 15%, rgba(215,168,255,.12), transparent 55%),
    radial-gradient(900px 650px at 55% 95%, rgba(134,251,214,.09), transparent 55%),
    linear-gradient(180deg,var(--bg0),var(--bg1));
}
canvas{position:fixed;inset:0;width:100%;height:100%;cursor:grab;touch-action:none}
canvas:active{cursor:grabbing}
.scanlines,.grain{position:fixed;inset:0;pointer-events:none;mix-blend-mode:overlay}
.scanlines{opacity:.14;background:linear-gradient(to bottom,rgba(255,255,255,.05) 1px,transparent 1px);background-size:100% 3px}
.grain{opacity:.10;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.45'/%3E%3C/svg%3E");background-size:220px 220px}

.hud{position:fixed;left:12px;right:12px;top:12px;z-index:20;display:flex;gap:10px;align-items:center;padding-top:env(safe-area-inset-top)}
.logoBtn{
  width:44px;height:44px;border-radius:14px;cursor:pointer;user-select:none;flex:0 0 auto;
  background:
    radial-gradient(18px 18px at 30% 30%, rgba(134,251,214,.30), rgba(0,0,0,.05)),
    radial-gradient(18px 18px at 70% 70%, rgba(215,168,255,.25), rgba(0,0,0,.05)),
    linear-gradient(180deg, rgba(13,20,34,.85), rgba(8,12,20,.85));
  border:1px solid rgba(255,255,255,.14);
  box-shadow: 0 12px 40px rgba(0,0,0,.35), 0 0 30px rgba(134,251,214,.12);
  display:grid;place-items:center;
}
.logoBtn span{font-weight:950;letter-spacing:.06em;font-family:var(--mono);font-size:12px;color:rgba(234,241,255,.92)}
.toolbarWrap{flex:1;min-width:0}
.toolbar{
  display:flex;gap:8px;align-items:center;flex-wrap:wrap;
  padding:8px;border-radius:16px;
  background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10);
  backdrop-filter:var(--glass);box-shadow:var(--shadow);
}
.btn{
  height:34px;padding:0 10px;border-radius:12px;
  border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);
  color:var(--txt);cursor:pointer;font-weight:900;letter-spacing:.02em;user-select:none;
  font-size:12px;font-family:var(--sans);
}
.btn:hover{background:rgba(0,0,0,.28)}
.btn:active{transform:scale(.96)}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.btn.primary{border-color:rgba(134,251,214,.35);background:linear-gradient(180deg,rgba(134,251,214,.16),rgba(0,0,0,.12))}
.btn.danger{border-color:rgba(255,106,139,.35);background:linear-gradient(180deg,rgba(255,106,139,.16),rgba(0,0,0,.12))}
.pill{display:flex;gap:6px;align-items:center;height:34px;padding:0 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.12);font-size:12px;white-space:nowrap}
.pill input[type="checkbox"]{accent-color:var(--good);cursor:pointer}
.pill label{cursor:pointer;user-select:none}
.field{display:flex;gap:8px;align-items:center;height:34px;padding:0 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.12);font-size:12px}
.field input[type="text"]{background:transparent;border:0;outline:none;color:var(--txt);font-family:var(--mono);font-size:12px;width:120px}

.fab{position:fixed;right:12px;bottom:12px;z-index:22;padding-bottom:env(safe-area-inset-bottom)}

.drawerWrap{position:fixed;inset:0;pointer-events:none;z-index:40}
.drawerWrap.open{pointer-events:auto}
.scrim{position:absolute;inset:0;background:rgba(0,0,0,.60);opacity:0;transition:opacity .18s ease;cursor:pointer}
.drawerWrap.open .scrim{opacity:1}
.drawer{
  position:absolute;inset:0;transform:translateY(14px);opacity:0;
  transition:transform .20s ease,opacity .20s ease;
  display:flex;padding:12px;
  padding-top:calc(12px + env(safe-area-inset-top));
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
}
.drawerWrap.open .drawer{transform:translateY(0);opacity:1}

.panel{
  flex:1;border-radius:22px;
  background:rgba(7,10,16,.78);
  border:1px solid rgba(255,255,255,.12);
  box-shadow:var(--shadow);
  backdrop-filter:var(--glass);
  overflow:hidden;display:flex;flex-direction:column;min-height:0;
}
.hd{
  padding:12px;border-bottom:1px solid rgba(255,255,255,.10);
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap
}
.hd .h{font-weight:950;letter-spacing:.08em;font-size:12px;color:rgba(234,241,255,.88);font-family:var(--mono)}
.bd{padding:12px;overflow-y:auto;min-height:0;display:flex;gap:12px;flex:1;flex-direction:column}

.block{margin-bottom:14px}
.blockTitle{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:rgba(234,241,255,.55);margin-bottom:8px;font-family:var(--mono)}
.stat{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.08)}
.stat:last-child{border:0}
.statLabel{font-size:12px;color:rgba(234,241,255,.68)}
.statVal{font-size:14px;font-weight:700;font-family:var(--mono);color:var(--good)}

.chip{
  padding:8px 10px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10);
  border-radius:10px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:8px;
  transition:all .12s;
}
.chip:hover{background:rgba(0,0,0,.28);border-color:rgba(134,251,214,.30)}
.chip:active{transform:scale(.98)}
.dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.chipName{flex:1;font-size:12px;font-weight:600;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.chipMeta{font-size:10px;color:var(--mut)}

textarea{
  width:100%;height:160px;background:rgba(0,0,0,.24);border:1px solid rgba(255,255,255,.10);
  border-radius:10px;padding:10px;color:var(--txt);font-family:var(--mono);font-size:11px;
  resize:vertical;outline:none;
}
textarea:focus{border-color:rgba(134,251,214,.30)}

.empty{text-align:center;padding:24px 16px;color:var(--mut);font-size:13px}
.emptyIcon{font-size:32px;margin-bottom:8px;opacity:.4}

.toast{
  position:fixed;top:70px;left:50%;transform:translateX(-50%);
  background:rgba(7,10,16,.92);border:2px solid var(--good);
  padding:12px 20px;border-radius:12px;
  box-shadow:var(--shadow);backdrop-filter:var(--glass);
  z-index:100;display:none;font-size:13px;font-weight:600;
  max-width:90vw;
}
.toast.show{display:block;animation:slideDown .3s}

@keyframes slideDown{
  from{transform:translateX(-50%) translateY(-100%);opacity:0}
  to{transform:translateX(-50%) translateY(0);opacity:1}
}

@keyframes pulse{
  0%,100%{box-shadow:0 0 0 0 rgba(134,251,214,.40)}
  50%{box-shadow:0 0 0 8px rgba(134,251,214,0)}
}
.pulse{animation:pulse 2s infinite}

@media(max-width:640px){
  .toolbar{gap:6px;padding:6px}
  .btn{padding:0 8px;font-size:11px}
  .field input[type="text"]{width:80px}
}
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<div class="scanlines"></div>
<div class="grain"></div>

<div class="hud">
  <div class="logoBtn" id="logoBtn">
    <span>NYXO</span>
  </div>
  <div class="toolbarWrap">
    <div class="toolbar">
      <button class="btn" id="homeBtn">üè†</button>
      <button class="btn" id="modeBtn">ZONES</button>
      <button class="btn" id="regenBtn">üîÑ</button>
      <div class="pill">
        <input type="checkbox" id="labels" checked>
        <label for="labels">Labels</label>
      </div>
      <div class="pill">
        <input type="checkbox" id="reveal">
        <label for="reveal">Reveal</label>
      </div>
      <div class="field">
        <label>üîç</label>
        <input type="text" id="filter" placeholder="Filtrer...">
      </div>
    </div>
  </div>
</div>

<div class="fab">
  <button class="btn primary pulse" id="monitorBtn">Monitor</button>
</div>

<div class="drawerWrap" id="drawerWrap">
  <div class="scrim" id="scrim"></div>
  <div class="drawer">
    <div class="panel">
      <div class="hd">
        <span class="h">NYXO MONITOR</span>
        <button class="btn" id="closeBtn">‚úï</button>
      </div>
      <div class="bd">
        <div class="block">
          <div class="blockTitle">Session</div>
          <div class="stat">
            <span class="statLabel">Entit√©s</span>
            <span class="statVal" id="statE">0</span>
          </div>
          <div class="stat">
            <span class="statLabel">Liens</span>
            <span class="statVal" id="statL">0</span>
          </div>
          <div class="stat">
            <span class="statLabel">Zones</span>
            <span class="statVal" id="statZ">0</span>
          </div>
        </div>
        
        <div class="block">
          <div class="blockTitle">Actions</div>
          <button class="btn primary" id="sampleBtn" style="width:100%;margin-bottom:6px">üì¶ Charger Sample</button>
          <button class="btn" id="importBtn" style="width:100%;margin-bottom:6px">üì• Importer JSON</button>
          <input type="file" id="fileInput" accept=".json" style="display:none">
          <button class="btn" id="exportBtn" style="width:100%;margin-bottom:6px">üì§ Exporter</button>
          <button class="btn danger" id="wipeBtn" style="width:100%">üóëÔ∏è Reset</button>
        </div>
        
        <div class="block" style="flex:1;min-height:0;display:flex;flex-direction:column">
          <div class="blockTitle">JSON Raw</div>
          <textarea id="jsonArea" placeholder='{"zones":[],"entities":[],"links":[]}'></textarea>
          <button class="btn primary" id="applyBtn" style="width:100%;margin-top:8px">‚úì Apply</button>
        </div>
        
        <div class="block" id="detailsBlock">
          <div class="blockTitle">D√©tails</div>
          <div id="details">
            <div class="empty">
              <div class="emptyIcon">üîç</div>
              <div>Cliquez sur une entit√©</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const ui={
  logoBtn:document.getElementById("logoBtn"),
  homeBtn:document.getElementById("homeBtn"),
  modeBtn:document.getElementById("modeBtn"),
  regenBtn:document.getElementById("regenBtn"),
  labels:document.getElementById("labels"),
  reveal:document.getElementById("reveal"),
  filter:document.getElementById("filter"),
  monitorBtn:document.getElementById("monitorBtn"),
  drawerWrap:document.getElementById("drawerWrap"),
  scrim:document.getElementById("scrim"),
  closeBtn:document.getElementById("closeBtn"),
  statE:document.getElementById("statE"),
  statL:document.getElementById("statL"),
  statZ:document.getElementById("statZ"),
  sampleBtn:document.getElementById("sampleBtn"),
  importBtn:document.getElementById("importBtn"),
  fileInput:document.getElementById("fileInput"),
  exportBtn:document.getElementById("exportBtn"),
  wipeBtn:document.getElementById("wipeBtn"),
  jsonArea:document.getElementById("jsonArea"),
  applyBtn:document.getElementById("applyBtn"),
  details:document.getElementById("details"),
  toast:document.getElementById("toast")
};

const LS_KEY="nyxo_v2";
const MODE={ZONES:"ZONES",GRAPH:"GRAPH"};
let mode=MODE.ZONES;
let db={zones:[],entities:[],links:[],meta:{}};
let view={x:0,y:0,z:1};
let selectedId=null;
let hoverId=null;
let drawerOpen=false;

function toast(msg){
  ui.toast.textContent=msg;
  ui.toast.classList.add("show");
  setTimeout(()=>ui.toast.classList.remove("show"),2500);
}

function fit(){
  const dpr=window.devicePixelRatio||1;
  canvas.width=canvas.clientWidth*dpr;
  canvas.height=canvas.clientHeight*dpr;
  ctx.scale(dpr,dpr);
}
fit();
window.addEventListener("resize",()=>{fit();render()});

function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
function hash(s){let h=0;for(let i=0;i<s.length;i++)h=((h<<5)-h)+s.charCodeAt(i)|0;return Math.abs(h)}
function short(t,max=18){if(!t||t.length<=max)return t;return t.substring(0,max-1)+"‚Ä¶"}
function esc(t){const d=document.createElement("div");d.textContent=t;return d.innerHTML}

const COL={ASTRO:"#86fbd6",TAROT:"#d7a8ff",NEUTRE:"#8fa8d0"};
function getCol(layer){return COL[layer]||COL.NEUTRE}

function s2w(sx,sy){
  const w=canvas.clientWidth,h=canvas.clientHeight;
  return {x:(sx-w/2)/view.z-view.x,y:(sy-h/2)/view.z-view.y};
}

function render(){
  const w=canvas.clientWidth,h=canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  
  ctx.save();
  ctx.translate(w/2,h/2);
  ctx.scale(view.z,view.z);
  ctx.translate(view.x,view.y);
  
  db.zones.forEach(z=>{
    const c=getCol(z.layer);
    ctx.fillStyle=c+"22";
    ctx.beginPath();
    ctx.arc(z.x||0,z.y||0,140,0,Math.PI*2);
    ctx.fill();
    
    ctx.fillStyle=c+"66";
    ctx.font="11px monospace";
    ctx.textAlign="center";
    ctx.fillText(z.label||z.id,z.x||0,z.y||0);
  });
  
  ctx.strokeStyle="rgba(134,251,214,.15)";
  ctx.lineWidth=1;
  db.links.forEach(l=>{
    const e1=db.entities.find(e=>e.id===l.from);
    const e2=db.entities.find(e=>e.id===l.to);
    if(!e1||!e2)return;
    const hl=selectedId&&(l.from===selectedId||l.to===selectedId);
    if(hl){ctx.strokeStyle="rgba(134,251,214,.40)";ctx.lineWidth=2}
    else{ctx.strokeStyle="rgba(134,251,214,.15)";ctx.lineWidth=1}
    ctx.beginPath();
    ctx.moveTo(e1.x||0,e1.y||0);
    ctx.lineTo(e2.x||0,e2.y||0);
    ctx.stroke();
  });
  
  db.entities.forEach(e=>{
    const sel=selectedId===e.id;
    const hov=hoverId===e.id;
    const r=sel?8:hov?6.5:5.5;
    const c=getCol(e.layer);
    if(sel){ctx.shadowColor=c;ctx.shadowBlur=20}else{ctx.shadowBlur=0}
    ctx.fillStyle=c;
    ctx.beginPath();
    ctx.arc(e.x||0,e.y||0,r,0,Math.PI*2);
    ctx.fill();
    ctx.shadowBlur=0;
    ctx.strokeStyle=c+"aa";
    ctx.lineWidth=1.2;
    ctx.beginPath();
    ctx.arc(e.x||0,e.y||0,r+2,0,Math.PI*2);
    ctx.stroke();
  });
  
  if(ui.labels.checked&&view.z>1&&db.entities.length>0){
    const max=view.z>1.8?30:view.z>1.4?15:8;
    const show=db.entities.slice(0,max);
    ctx.font="600 10px sans-serif";
    ctx.textAlign="center";
    show.forEach(e=>{
      const name=e.display?.masked_name||e.id;
      const lbl=short(name,16);
      const w=ctx.measureText(lbl).width;
      ctx.fillStyle="rgba(0,0,0,.7)";
      ctx.fillRect((e.x||0)-w/2-4,(e.y||0)+10,w+8,14);
      ctx.fillStyle="#fff";
      ctx.fillText(lbl,e.x||0,(e.y||0)+20);
    });
  }
  
  ctx.restore();
  
  ui.statE.textContent=db.entities.length;
  ui.statL.textContent=db.links.length;
  ui.statZ.textContent=db.zones.length;
}

function physics(){
  const zg=mode===MODE.ZONES?.18:.04;
  const rep=mode===MODE.GRAPH?900:400;
  
  db.entities.forEach(e=>{
    const z=db.zones.find(zz=>zz.id===e.zone);
    if(z){
      const dx=(z.x||0)-(e.x||0),dy=(z.y||0)-(e.y||0),d=Math.sqrt(dx*dx+dy*dy);
      if(d>1){e.vx=(e.vx||0)+(dx/d)*zg;e.vy=(e.vy||0)+(dy/d)*zg}
    }
  });
  
  for(let i=0;i<db.entities.length;i++){
    for(let j=i+1;j<db.entities.length;j++){
      const e1=db.entities[i],e2=db.entities[j];
      const dx=(e2.x||0)-(e1.x||0),dy=(e2.y||0)-(e1.y||0),d=Math.sqrt(dx*dx+dy*dy);
      if(d>0&&d<180){
        const f=rep/(d*d+1);
        const fx=(dx/d)*f,fy=(dy/d)*f;
        e1.vx=(e1.vx||0)-fx;e1.vy=(e1.vy||0)-fy;
        e2.vx=(e2.vx||0)+fx;e2.vy=(e2.vy||0)+fy;
      }
    }
  }
  
  const ss=mode===MODE.GRAPH?.12:.05;
  db.links.forEach(l=>{
    const e1=db.entities.find(e=>e.id===l.from);
    const e2=db.entities.find(e=>e.id===l.to);
    if(!e1||!e2)return;
    const dx=(e2.x||0)-(e1.x||0),dy=(e2.y||0)-(e1.y||0),d=Math.sqrt(dx*dx+dy*dy);
    if(d>1){
      const diff=d-100,f=diff*ss;
      const fx=(dx/d)*f,fy=(dy/d)*f;
      e1.vx=(e1.vx||0)+fx;e1.vy=(e1.vy||0)+fy;
      e2.vx=(e2.vx||0)-fx;e2.vy=(e2.vy||0)-fy;
    }
  });
  
  db.entities.forEach(e=>{
    e.vx=(e.vx||0)*.85;e.vy=(e.vy||0)*.85;
    e.vx=clamp(e.vx||0,-7,7);e.vy=clamp(e.vy||0,-7,7);
    e.x=(e.x||0)+(e.vx||0);e.y=(e.y||0)+(e.vy||0);
  });
}

let anim=null;
function start(){
  if(anim)return;
  function loop(){physics();render();anim=requestAnimationFrame(loop)}
  loop();
}

let drag=false,dragStart={x:0,y:0},viewStart={x:0,y:0};
canvas.addEventListener("pointerdown",e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  const world=s2w(mx,my);
  let hit=null;
  for(let i=db.entities.length-1;i>=0;i--){
    const ent=db.entities[i];
    const dx=world.x-(ent.x||0),dy=world.y-(ent.y||0),d=Math.sqrt(dx*dx+dy*dy);
    if(d<11/view.z){hit=ent;break}
  }
  if(hit){
    selectEntity(hit.id);
    if(!drawerOpen)setDrawer(true);
  }else{
    drag=true;dragStart={x:mx,y:my};viewStart={x:view.x,y:view.y};
  }
});
canvas.addEventListener("pointermove",e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  if(drag){
    const dx=mx-dragStart.x,dy=my-dragStart.y;
    view.x=viewStart.x+dx/view.z;
    view.y=viewStart.y+dy/view.z;
    render();
  }else{
    const world=s2w(mx,my);
    let hov=null;
    for(let i=db.entities.length-1;i>=0;i--){
      const ent=db.entities[i];
      const dx=world.x-(ent.x||0),dy=world.y-(ent.y||0),d=Math.sqrt(dx*dx+dy*dy);
      if(d<11/view.z){hov=ent;break}
    }
    hoverId=hov?hov.id:null;
    render();
  }
});
canvas.addEventListener("pointerup",()=>{drag=false});
canvas.addEventListener("wheel",e=>{
  e.preventDefault();
  const delta=-e.deltaY*.0009;
  view.z=clamp(view.z+delta,.5,3.5);
  render();
});

function selectEntity(id){
  selectedId=id;
  const e=db.entities.find(ent=>ent.id===id);
  if(!e){
    ui.details.innerHTML='<div class="empty"><div class="emptyIcon">‚ùå</div><div>Entit√© introuvable</div></div>';
    return;
  }
  const name=e.display?.masked_name||e.id;
  const linksFrom=db.links.filter(l=>l.from===id);
  const linksTo=db.links.filter(l=>l.to===id);
  let html=`<div style="margin-bottom:12px">
    <strong style="font-size:14px;display:block;margin-bottom:6px">${esc(name)}</strong>
    <div style="font-size:11px;color:var(--mut)">Type: ${esc(e.type)} ‚Ä¢ Layer: ${esc(e.layer)}</div>
  </div>`;
  
  if(linksFrom.length){
    html+=`<div style="font-size:11px;font-weight:700;margin:10px 0 6px;color:var(--mut)">‚Üí Sortants (${linksFrom.length})</div>`;
    linksFrom.slice(0,5).forEach(l=>{
      const t=db.entities.find(ent=>ent.id===l.to);
      if(t){
        const tn=t.display?.masked_name||t.id;
        html+=`<div class="chip" data-id="${esc(l.to)}"><span class="dot" style="background:${getCol(t.layer)}"></span><span class="chipName">${esc(short(tn))}</span></div>`;
      }
    });
  }
  
  if(linksTo.length){
    html+=`<div style="font-size:11px;font-weight:700;margin:10px 0 6px;color:var(--mut)">‚Üê Entrants (${linksTo.length})</div>`;
    linksTo.slice(0,5).forEach(l=>{
      const s=db.entities.find(ent=>ent.id===l.from);
      if(s){
        const sn=s.display?.masked_name||s.id;
        html+=`<div class="chip" data-id="${esc(l.from)}"><span class="dot" style="background:${getCol(s.layer)}"></span><span class="chipName">${esc(short(sn))}</span></div>`;
      }
    });
  }
  
  ui.details.innerHTML=html;
  ui.details.querySelectorAll(".chip").forEach(chip=>{
    chip.addEventListener("click",()=>{
      const targetId=chip.getAttribute("data-id");
      if(targetId)selectEntity(targetId);
    });
  });
  render();
}

function setDrawer(open){
  drawerOpen=open;
  if(open){ui.drawerWrap.classList.add("open");ui.monitorBtn.classList.remove("pulse")}
  else{ui.drawerWrap.classList.remove("open")}
}

ui.logoBtn.addEventListener("click",()=>setDrawer(true));
ui.monitorBtn.addEventListener("click",()=>setDrawer(true));
ui.closeBtn.addEventListener("click",()=>setDrawer(false));
ui.scrim.addEventListener("click",()=>setDrawer(false));

ui.homeBtn.addEventListener("click",()=>{view.x=0;view.y=0;view.z=1;render();toast("Vue recentr√©e")});
ui.modeBtn.addEventListener("click",()=>{mode=mode===MODE.ZONES?MODE.GRAPH:MODE.ZONES;ui.modeBtn.textContent=mode;toast("Mode "+mode)});
ui.regenBtn.addEventListener("click",()=>{
  db.entities.forEach(e=>{
    const z=db.zones.find(zz=>zz.id===e.zone);
    if(z){
      const h=hash(e.id),angle=(h%360)*(Math.PI/180),radius=50+(h%90);
      e.x=(z.x||0)+Math.cos(angle)*radius;
      e.y=(z.y||0)+Math.sin(angle)*radius;
      e.vx=0;e.vy=0;
    }
  });
  render();
  toast("Positions r√©g√©n√©r√©es");
});

ui.labels.addEventListener("change",()=>render());
ui.reveal.addEventListener("change",()=>render());
ui.filter.addEventListener("input",()=>render());

function loadSample(){
  const zones=[...Array(5)].map((_,i)=>({
    id:`Z-BXL-${1000+i*30}`,
    commune:["Centre","Schaerbeek","Anderlecht","Ixelles","Jette"][i],
    x:[0,300,-300,200,-350][i],
    y:[0,-150,150,200,-250][i],
    layer:["ASTRO","TAROT","NEUTRE","ASTRO","TAROT"][i],
    label:["Centre","Schaerbeek","Anderlecht","Ixelles","Jette"][i]
  }));
  
  const types=["lieu_de_liens","ssm","centre_jour","federation","reseau"];
  const layers=["ASTRO","TAROT","NEUTRE"];
  const entities=[...Array(40)].map((_,i)=>{
    const zIdx=hash(`e${i}`)%zones.length;
    const z=zones[zIdx];
    const type=types[hash(`t${i}`)%types.length];
    const layer=layers[hash(`l${i}`)%layers.length];
    const h=hash(i.toString()),angle=(h%360)*(Math.PI/180),radius=50+(h%80);
    return {
      id:`E-${String(i+1).padStart(3,"0")}`,
      type,zone:z.id,layer,
      confidence:.65+(hash(`c${i}`)%35)/100,
      display:{masked_name:`Entit√©_${i+1}`,real_name:`Structure ${i+1}`},
      tags:["sample",type],
      x:z.x+Math.cos(angle)*radius,
      y:z.y+Math.sin(angle)*radius,
      vx:0,vy:0
    };
  });
  
  const links=[];
  let lid=1;
  const ltypes=["finances","supports","partners_with","coordinates"];
  entities.forEach((e,idx)=>{
    const n=1+(hash(`n${e.id}`)%2);
    for(let j=0;j<n;j++){
      const tIdx=(idx+j+1)%entities.length;
      const t=entities[tIdx];
      if(e.id!==t.id){
        links.push({
          id:`L-${String(lid++).padStart(3,"0")}`,
          type:ltypes[hash(`lt${lid}`)%ltypes.length],
          from:e.id,to:t.id,
          confidence:.75+(hash(`lc${lid}`)%25)/100
        });
      }
    }
  });
  
  const data={meta:{dataset:"nyxo-sample",generatedAt:new Date().toISOString()},zones,entities,links};
  ui.jsonArea.value=JSON.stringify(data,null,2);
  applyData(data);
  toast("Sample charg√©: "+entities.length+" entit√©s");
}

function applyData(data){
  db.zones=data.zones||[];
  db.entities=data.entities||[];
  db.links=data.links||[];
  db.meta=data.meta||{};
  
  db.entities.forEach(e=>{
    if(e.x===undefined||e.y===undefined){
      const z=db.zones.find(zz=>zz.id===e.zone);
      if(z){
        const h=hash(e.id),angle=(h%360)*(Math.PI/180),radius=50+(h%100);
        e.x=(z.x||0)+Math.cos(angle)*radius;
        e.y=(z.y||0)+Math.sin(angle)*radius;
      }else{e.x=0;e.y=0}
    }
    if(e.vx===undefined)e.vx=0;
    if(e.vy===undefined)e.vy=0;
  });
  
  render();
  save();
  toast("Donn√©es appliqu√©es: "+db.entities.length+" entit√©s");
}

function save(){
  try{localStorage.setItem(LS_KEY,JSON.stringify({zones:db.zones,entities:db.entities,links:db.links,meta:db.meta,view}))}catch(e){}
}

function load(){
  try{
    const s=localStorage.getItem(LS_KEY);
    if(s){
      const data=JSON.parse(s);
      db.zones=data.zones||[];
      db.entities=data.entities||[];
      db.links=data.links||[];
      db.meta=data.meta||{};
      if(data.view)view=data.view;
    }
  }catch(e){}
}

ui.sampleBtn.addEventListener("click",()=>{if(confirm("Charger sample ?"))loadSample()});

ui.importBtn.addEventListener("click",()=>ui.fileInput.click());
ui.fileInput.addEventListener("change",()=>{
  const file=ui.fileInput.files&&ui.fileInput.files[0];
  if(!file)return;
  
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const txt=e.target.result;
      const data=JSON.parse(txt);
      ui.jsonArea.value=JSON.stringify(data,null,2);
      applyData(data);
      setDrawer(true);
      toast("Import r√©ussi!");
    }catch(err){
      toast("Erreur import: "+err.message);
      console.error("Import error:",err);
    }
  };
  reader.onerror=()=>{
    toast("Erreur lecture fichier");
  };
  reader.readAsText(file);
  
  ui.fileInput.value="";
});

ui.applyBtn.addEventListener("click",()=>{
  try{
    const data=JSON.parse(ui.jsonArea.value||"{}");
    applyData(data);
  }catch(e){toast("Erreur JSON: "+e.message)}
});

ui.exportBtn.addEventListener("click",()=>{
  const data={meta:db.meta||{dataset:"nyxo-export",exportedAt:new Date().toISOString()},zones:db.zones,entities:db.entities,links:db.links};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download=`nyxo-export-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("Export r√©ussi!");
});

ui.wipeBtn.addEventListener("click",()=>{if(confirm("‚ö†Ô∏è Supprimer toutes les donn√©es ?")){try{localStorage.removeItem(LS_KEY)}catch(e){}location.reload()}});

document.addEventListener("keydown",e=>{
  if(e.key==="Escape"&&drawerOpen){setDrawer(false);return}
  if(e.key==="Home"){e.preventDefault();ui.homeBtn.click();return}
  if(e.key==="r"||e.key==="R"){if(!e.ctrlKey&&!e.metaKey){ui.regenBtn.click()}return}
  if(e.key==="m"||e.key==="M"){ui.modeBtn.click();return}
  if((e.ctrlKey||e.metaKey)&&e.key==="e"){e.preventDefault();ui.exportBtn.click();return}
});

load();
render();
start();
console.log("üß† NYXO Portal ‚Ä¢ Bruxelles ‚Ä¢ Open Data Sant√© Mentale");
toast("üåü NYXO Portal charg√©");
</script>

</body>
</html>
