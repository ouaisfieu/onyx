
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>NYXO ‚Ä¢ Bruxelles ‚Ä¢ Lieux de liens & Sant√© mentale</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#10121a;
      --panel2:#0f1118;
      --fg:#f2f3f5;
      --muted:#a7adba;
      --line:#23283a;
      --chip:#171a25;
      --accent:#b38bff;     /* mauve n√©on */
      --accent2:#62f6a7;    /* vert */
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:20px;
      --font: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --fs: 16px;
      --tap: 46px;
      --focus: 0 0 0 3px rgba(179,139,255,.25);
      --anim: 1;
    }
    [data-theme="light"]{
      --bg:#f7f8fb;
      --panel:#ffffff;
      --panel2:#fbfbff;
      --fg:#0d1220;
      --muted:#4a5568;
      --line:#e4e7f2;
      --chip:#f2f3fa;
      --shadow: 0 10px 30px rgba(10,20,40,.12);
      --focus: 0 0 0 3px rgba(87,53,255,.18);
    }
    [data-reduce-motion="1"]{ --anim: 0; }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 10% -10%, rgba(179,139,255,.18), transparent 55%),
                  radial-gradient(1200px 800px at 110% 0%, rgba(98,246,167,.12), transparent 55%),
                  var(--bg);
      color:var(--fg);
      font-family:var(--font);
      font-size:var(--fs);
      line-height:1.35;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    button, input, select, textarea{
      font:inherit;
      color:inherit;
    }
    button{
      background:transparent;
      border:1px solid var(--line);
      border-radius:14px;
      padding:.6rem .8rem;
      min-height:var(--tap);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.5rem;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible{
      outline:none;
      box-shadow:var(--focus);
    }
    button.primary{
      border-color:rgba(179,139,255,.35);
      background: linear-gradient(180deg, rgba(179,139,255,.14), rgba(179,139,255,.04));
    }
    button.green{
      border-color: rgba(98,246,167,.35);
      background: linear-gradient(180deg, rgba(98,246,167,.14), rgba(98,246,167,.04));
    }
    button.bad{
      border-color: rgba(255,107,107,.35);
      background: linear-gradient(180deg, rgba(255,107,107,.14), rgba(255,107,107,.04));
    }
    button.ghost{
      border-color:transparent;
      background: transparent;
    }
    button.block{ width:100%; }
    button[disabled]{ opacity:.55; cursor:not-allowed; }

    input, select, textarea{
      width:100%;
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:.65rem .8rem;
      min-height:var(--tap);
    }
    [data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea{
      background: rgba(10,20,40,.04);
    }
    textarea{ min-height: 120px; resize:vertical; font-family:var(--mono); font-size:.92rem; }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px) saturate(1.2);
      background: linear-gradient(180deg, rgba(10,12,18,.92), rgba(10,12,18,.72));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    [data-theme="light"] .topbar{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
      border-bottom:1px solid rgba(10,20,40,.08);
    }
    .topbar .row{
      display:flex; align-items:center; gap:.6rem;
      padding: .75rem .9rem;
      max-width: 1100px;
      margin: 0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:.6rem;
      min-width: 0;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(98,246,167,.55), transparent 70%),
        radial-gradient(14px 14px at 70% 40%, rgba(179,139,255,.55), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    [data-theme="light"] .logo{
      border:1px solid rgba(10,20,40,.12);
    }
    .brand h1{
      margin:0;
      font-size:1rem;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .sub{
      color:var(--muted);
      font-size:.78rem;
      margin-top:.05rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .spacer{ flex:1; }

    .pill{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.38rem .6rem;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      color: var(--muted);
      font-size:.8rem;
    }
    [data-theme="light"] .pill{
      border:1px solid rgba(10,20,40,.10);
      background: rgba(10,20,40,.03);
    }

    /* Layout */
    .content{
      flex:1;
      display:flex;
      max-width: 1100px;
      margin: 0 auto;
      width:100%;
      gap: .9rem;
      padding: .9rem .9rem 5.2rem; /* bottom nav space */
    }
    @media (min-width: 900px){
      .content{ padding-bottom: 1rem; }
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-width:0;
    }
    [data-theme="light"] .panel{
      background: linear-gradient(180deg, rgba(10,20,40,.03), rgba(10,20,40,.02));
      border:1px solid rgba(10,20,40,.08);
    }
    .panel .ph{
      padding:.85rem .95rem;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
      display:flex; align-items:center; gap:.6rem;
    }
    [data-theme="light"] .panel .ph{
      background: rgba(10,20,40,.03);
      border-bottom:1px solid rgba(10,20,40,.08);
    }
    .panel .ph h2{
      font-size:.95rem;
      margin:0;
      letter-spacing:.2px;
    }
    .panel .ph .hint{ color:var(--muted); font-size:.8rem; margin-left:auto; }
    .panel .pb{ padding:.9rem .95rem; }

    /* Mobile-first: single column; desktop: two columns */
    .left, .right{ width:100%; }
    @media (min-width: 900px){
      .left{ width: 42%; }
      .right{ width: 58%; }
      .content{ align-items:stretch; }
      .left, .right{ display:flex; flex-direction:column; gap:.9rem; }
    }
    @media (max-width: 899px){
      .left, .right{ display:none; }
      .left[data-active="1"], .right[data-active="1"]{ display:block; }
    }

    /* Bottom nav (mobile) */
    .bottomnav{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      display:flex; gap:.35rem;
      padding:.55rem .6rem calc(.55rem + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(10,12,18,.55), rgba(10,12,18,.92));
      border-top:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(10px) saturate(1.2);
    }
    [data-theme="light"] .bottomnav{
      background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.92));
      border-top:1px solid rgba(10,20,40,.10);
    }
    .navbtn{
      flex:1;
      border-radius: 16px;
      min-height: 52px;
      display:flex; flex-direction:column;
      gap:.15rem;
      align-items:center; justify-content:center;
      font-size:.75rem;
      color: var(--muted);
    }
    .navbtn.active{
      border-color: rgba(179,139,255,.35);
      color: var(--fg);
      background: linear-gradient(180deg, rgba(179,139,255,.18), rgba(179,139,255,.05));
    }
    .navbtn .ico{ font-size:1.05rem; line-height:1; }

    @media (min-width: 900px){
      .bottomnav{ display:none; }
    }

    /* Lists */
    .stack{ display:flex; flex-direction:column; gap:.7rem; }
    .row2{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr; gap:.6rem; }
    @media (max-width: 460px){ .row3{ grid-template-columns:1fr; } }

    .chips{ display:flex; flex-wrap:wrap; gap:.4rem; }
    .chip{
      padding:.28rem .55rem;
      border-radius: 999px;
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size:.78rem;
      white-space:nowrap;
    }
    [data-theme="light"] .chip{
      background: rgba(10,20,40,.03);
      border:1px solid rgba(10,20,40,.08);
    }

    .list{
      display:flex; flex-direction:column; gap:.55rem;
      max-height: 52vh;
      overflow:auto;
      padding-right:.2rem;
    }
    @media (min-width: 900px){
      .list{ max-height: unset; flex:1; }
    }
    .item{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
      border-radius: 14px;
      padding:.75rem .8rem;
      display:flex; gap:.7rem;
      align-items:flex-start;
      cursor:pointer;
      user-select:none;
    }
    [data-theme="light"] .item{
      background: rgba(10,20,40,.03);
      border:1px solid rgba(10,20,40,.08);
    }
    .item:hover{ border-color: rgba(179,139,255,.22); }
    .item.active{ border-color: rgba(179,139,255,.50); box-shadow: 0 0 0 2px rgba(179,139,255,.15); }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(179,139,255,.6);
      margin-top:.25rem;
      flex:0 0 auto;
      box-shadow: 0 0 0 4px rgba(179,139,255,.10);
    }
    .dot.green{ background: rgba(98,246,167,.7); box-shadow: 0 0 0 4px rgba(98,246,167,.12); }
    .dot.red{ background: rgba(255,107,107,.8); box-shadow: 0 0 0 4px rgba(255,107,107,.12); }
    .ititle{ margin:0; font-size:.98rem; letter-spacing:.1px; }
    .isub{ color:var(--muted); font-size:.82rem; margin-top:.18rem; }
    .metaLine{ color:var(--muted); font-size:.78rem; margin-top:.35rem; font-family:var(--mono); opacity:.92; }

    /* Detail */
    .titlebar{
      display:flex; align-items:flex-start; gap:.7rem;
    }
    .titlebar h3{
      margin:0;
      font-size:1.08rem;
      letter-spacing:.15px;
    }
    .titlebar .small{
      color:var(--muted);
      font-size:.8rem;
      margin-top:.12rem;
    }
    .actions{
      margin-left:auto;
      display:flex; gap:.35rem; flex-wrap:wrap; justify-content:flex-end;
    }
    .actions button{ min-height: 42px; padding:.5rem .6rem; border-radius: 14px; }
    .kvs{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:.4rem .75rem;
      margin-top:.9rem;
    }
    @media (max-width: 520px){ .kvs{ grid-template-columns:1fr; } }
    .kvs .k{ color:var(--muted); font-size:.84rem; }
    .kvs .v{ font-size:.93rem; white-space:pre-wrap; word-break:break-word; }
    .divider{ height:1px; background: rgba(255,255,255,.08); margin:.9rem 0; }
    [data-theme="light"] .divider{ background: rgba(10,20,40,.08); }

    /* Modals */
    .modal{
      position:fixed; inset:0; z-index:90;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      padding: 1rem;
    }
    .modal[data-open="1"]{ display:flex; }
    .modal .box{
      margin:auto;
      width:min(720px, 100%);
      max-height: 86vh;
      overflow:auto;
      background: var(--panel);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      box-shadow: var(--shadow);
    }
    [data-theme="light"] .modal .box{
      border:1px solid rgba(10,20,40,.10);
      background: var(--panel);
    }
    .modal .mh{
      padding:.9rem 1rem;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; gap:.6rem;
    }
    [data-theme="light"] .modal .mh{
      border-bottom:1px solid rgba(10,20,40,.08);
    }
    .modal .mh h3{ margin:0; font-size:1rem; }
    .modal .mb{ padding:1rem; }
    .modal .mh .close{ margin-left:auto; }

    /* Blinks */
    @keyframes neonPulse{
      0%{ box-shadow: 0 0 0 0 rgba(179,139,255,.0), 0 0 0 0 rgba(179,139,255,.0); }
      20%{ box-shadow: 0 0 0 3px rgba(179,139,255,.22), 0 0 25px 6px rgba(179,139,255,.18); }
      55%{ box-shadow: 0 0 0 3px rgba(179,139,255,.28), 0 0 28px 8px rgba(179,139,255,.22); }
      100%{ box-shadow: 0 0 0 0 rgba(179,139,255,.0), 0 0 0 0 rgba(179,139,255,.0); }
    }
    .blink-purple{
      animation: neonPulse 1.1s ease-in-out infinite;
      border-color: rgba(179,139,255,.55) !important;
      background: linear-gradient(180deg, rgba(179,139,255,.22), rgba(179,139,255,.06)) !important;
    }

    @keyframes greenPulse{
      0%{ box-shadow: 0 0 0 0 rgba(98,246,167,.0), 0 0 0 0 rgba(98,246,167,.0); }
      25%{ box-shadow: 0 0 0 3px rgba(98,246,167,.22), 0 0 22px 6px rgba(98,246,167,.14); }
      55%{ box-shadow: 0 0 0 3px rgba(98,246,167,.28), 0 0 26px 8px rgba(98,246,167,.18); }
      100%{ box-shadow: 0 0 0 0 rgba(98,246,167,.0), 0 0 0 0 rgba(98,246,167,.0); }
    }
    .blink-green{ animation: greenPulse 1.2s ease-in-out infinite; }

    /* Safety */
    .warnbox{
      border:1px solid rgba(255,204,102,.35);
      background: linear-gradient(180deg, rgba(255,204,102,.12), rgba(255,204,102,.03));
      border-radius: 16px;
      padding:.85rem .9rem;
      color: var(--muted);
    }

    /* Drop zone */
    .drop{
      border:1px dashed rgba(255,255,255,.22);
      border-radius: 16px;
      padding: .85rem .9rem;
      background: rgba(0,0,0,.10);
      color: var(--muted);
    }
    [data-theme="light"] .drop{
      background: rgba(10,20,40,.03);
      border:1px dashed rgba(10,20,40,.20);
    }
    .drop.drag{
      border-color: rgba(179,139,255,.7);
      color: var(--fg);
      background: rgba(179,139,255,.08);
    }

    /* Small helpers */
    .muted{ color:var(--muted); }
    .mono{ font-family:var(--mono); }
    .tiny{ font-size:.82rem; }
    .rightAlign{ text-align:right; }
    .hide{ display:none !important; }
  </style>
</head>

<body>
<div class="app" id="app" data-theme="dark" data-reduce-motion="0">
  <div class="topbar">
    <div class="row">
      <div class="brand" role="banner" aria-label="NYXO Bruxelles">
        <div class="logo" aria-hidden="true"></div>
        <div style="min-width:0">
          <h1>NYXO ‚Ä¢ Bruxelles</h1>
          <div class="sub">Portail + espace de travail ‚Ä¢ donn√©es ouvertes ‚Ä¢ mobile-first</div>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="pill" id="pillState">üì¶ Aucun dataset</div>
      <button class="ghost" id="btnSettings" title="R√©glages">‚öôÔ∏è</button>
    </div>
  </div>

  <div class="content">
    <!-- LEFT (Monitor / Explore) -->
    <div class="left" id="leftPane" data-active="1">
      <div class="panel">
        <div class="ph">
          <h2>Onboarding (3 clics)</h2>
          <div class="hint" id="onboardingHint">1/3</div>
        </div>
        <div class="pb stack" id="onboarding">
          <div class="warnbox">
            <div><b>Important :</b> cette appli garde ta session localement (sur ton appareil).</div>
            <div class="tiny">Pour √©viter toute perte, utilise le bouton <b>EXPORT</b> (il clignote en mauve toutes les 3 minutes).</div>
          </div>

          <div class="row3">
            <button class="primary" id="btnPick">1) Importer JSON</button>
            <button id="btnTryFetch" title="Fonctionne uniquement si la page est servie via un serveur (pas en double-clic file://)">Essayer auto-chargement</button>
          </div>

          <div id="drop" class="drop">üóÇÔ∏è Glisse-d√©pose ici ton fichier <span class="mono">.json</span> (dataset ou export)</div>
          <input id="file" type="file" accept=".json,application/json" class="hide" />

          <div class="row3">
            <select id="role">
              <option value="citizen">2) Profil : Citoyen¬∑ne</option>
              <option value="pro">2) Profil : Pro / Association</option>
              <option value="admin">2) Profil : Admin / Coordination</option>
              <option value="funder">2) Profil : Financeur / Observateur</option>
            </select>
            <button class="green" id="btnStart">3) D√©marrer</button>
          </div>

          <div class="tiny muted">
            Si l‚Äôimport affiche ‚Äúintrouvable‚Äù, copie le JSON dans <b>T√©l√©chargements</b> / <b>Bureau</b> (OneDrive ‚Äú√† la demande‚Äù peut casser la lecture).
          </div>
        </div>
      </div>

      <div class="panel" id="monitorPanel">
        <div class="ph">
          <h2>Monitor</h2>
          <div class="hint" id="countHint">0</div>
        </div>
        <div class="pb stack">
          <div class="row2">
            <input id="q" placeholder="Rechercher (nom, mission, commune, public‚Ä¶)" />
            <select id="type">
              <option value="">Tous</option>
              <option value="lieu_de_lien">Lieux de liens</option>
              <option value="ssm">SSM</option>
              <option value="hotline">Lignes d‚Äô√©coute</option>
              <option value="hopital">H√¥pitaux / urgences</option>
              <option value="equipe_mobile">√âquipes mobiles</option>
              <option value="spad">SPAD</option>
              <option value="education_permanente">√âducation permanente</option>
              <option value="service">Autres services</option>
            </select>
          </div>

          <div class="row2">
            <button class="primary" id="btnBack" title="Retour">‚üµ</button>
            <button class="primary" id="btnForward" title="Avancer">‚ü∂</button>
            <button id="btnPin" title="√âpingler la s√©lection">üìå</button>
            <button id="btnClearSelection" class="ghost" title="D√©s√©lectionner">‚úï</button>
          </div>

          <div class="chips" id="chips"></div>

          <div class="list" id="list" aria-label="Liste d‚Äôentit√©s"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT (Detail / Work) -->
    <div class="right" id="rightPane" data-active="0">
      <div class="panel">
        <div class="ph">
          <h2>Fiche d√©taill√©e</h2>
          <div class="hint" id="detailHint">S√©lectionne un √©l√©ment</div>
        </div>
        <div class="pb" id="detail">
          <div class="warnbox">
            <b>Astuce :</b> utilise le monitor √† gauche pour ouvrir une fiche. Tu peux naviguer ‚üµ ‚ü∂ entre tes visites.
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="ph">
          <h2>Export & Pause</h2>
          <div class="hint">sauvegarde</div>
        </div>
        <div class="pb stack">
          <button class="primary block" id="btnExport">‚¨áÔ∏è EXPORTER (recommand√©)</button>
          <button class="green block" id="btnPause">üü¢ PAUSE (50 min)</button>

          <div class="tiny muted">
            L‚Äôexport cr√©e un fichier JSON complet (dataset + modifications locales). Garde-le en lieu s√ªr.
          </div>

          <div class="row3">
            <button id="btnCopy" class="ghost">üìã Copier JSON</button>
            <button id="btnReset" class="bad">üß® Reset local</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile bottom nav -->
  <div class="bottomnav" role="navigation" aria-label="Navigation">
    <button class="navbtn active" id="navExplore" data-target="left">
      <div class="ico">üß≠</div><div>Explorer</div>
    </button>
    <button class="navbtn" id="navDetail" data-target="right">
      <div class="ico">üßæ</div><div>Fiche</div>
    </button>
    <button class="navbtn" id="navWork" data-target="work">
      <div class="ico">üõ†Ô∏è</div><div>Travail</div>
    </button>
    <button class="navbtn" id="navExport" data-target="export">
      <div class="ico">üíæ</div><div>Export</div>
    </button>
  </div>

  <!-- Settings modal -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-label="R√©glages">
      <div class="mh">
        <h3>R√©glages (confort)</h3>
        <button class="close" id="btnCloseSettings">‚úï</button>
      </div>
      <div class="mb stack">
        <div class="row3">
          <button class="primary" id="btnTheme">üåó Th√®me : sombre</button>
          <button id="btnMotion">ü´ß Animations : ON</button>
        </div>
        <div class="row3">
          <label class="tiny">
            Taille du texte
            <input id="fontSize" type="range" min="14" max="20" step="1" />
          </label>
          <label class="tiny">
            Couleur d‚Äôaccent (mauve)
            <input id="accent" type="range" min="0" max="360" step="1" />
          </label>
        </div>
        <div class="warnbox">
          <b>Confidentialit√© :</b> rien n‚Äôest envoy√© en ligne. Tout reste sur ton appareil tant que tu n‚Äôexportes pas.
        </div>
      </div>
    </div>
  </div>

  <!-- Pause modal -->
  <div class="modal" id="pauseModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-label="Pause">
      <div class="mh">
        <h3>Pause</h3>
        <button class="close" id="btnClosePause">‚úï</button>
      </div>
      <div class="mb stack">
        <div class="warnbox">
          <div><b>Rappel :</b> fais une pause.</div>
          <div class="tiny">Hydrate-toi, l√®ve-toi, respire. Reviens quand tu veux.</div>
        </div>
        <button class="green block" id="btnSnooze">OK (prochain rappel dans 50 min)</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // ----------------------------
  // Storage keys
  // ----------------------------
  const LS = {
    SETTINGS: "nyxo_settings_v1",
    SESSION:  "nyxo_session_v1",
    DATA:     "nyxo_dataset_v1",
    OVERLAY:  "nyxo_overlay_v1",
    HISTORY:  "nyxo_history_v1",
    PINS:     "nyxo_pins_v1",
    LAST_EXPORT_AT: "nyxo_last_export_at_v1",
  };

  // ----------------------------
  // State
  // ----------------------------
  let RAW = null;            // Original imported object
  let G = null;              // Normalized graph {meta,sources,zones,entities,links,tasks}
  let overlay = { edits: {}, notes: {}, tags: {}, status: {} }; // user modifications only
  let pins = [];             // pinned ids
  let history = { list: [], idx: -1 }; // navigation history of selected node ids
  let role = "citizen";
  let started = false;

  // UI refs
  const app = document.getElementById("app");
  const pillState = document.getElementById("pillState");
  const onboarding = document.getElementById("onboarding");
  const onboardingHint = document.getElementById("onboardingHint");
  const monitorPanel = document.getElementById("monitorPanel");

  const q = document.getElementById("q");
  const typeSel = document.getElementById("type");
  const list = document.getElementById("list");
  const chips = document.getElementById("chips");
  const countHint = document.getElementById("countHint");

  const detail = document.getElementById("detail");
  const detailHint = document.getElementById("detailHint");

  const btnPick = document.getElementById("btnPick");
  const btnTryFetch = document.getElementById("btnTryFetch");
  const fileInput = document.getElementById("file");
  const drop = document.getElementById("drop");

  const roleSel = document.getElementById("role");
  const btnStart = document.getElementById("btnStart");

  const btnBack = document.getElementById("btnBack");
  const btnForward = document.getElementById("btnForward");
  const btnPin = document.getElementById("btnPin");
  const btnClearSelection = document.getElementById("btnClearSelection");

  const btnExport = document.getElementById("btnExport");
  const btnCopy = document.getElementById("btnCopy");
  const btnReset = document.getElementById("btnReset");

  const btnPause = document.getElementById("btnPause");

  // Settings modal
  const settingsModal = document.getElementById("settingsModal");
  const btnSettings = document.getElementById("btnSettings");
  const btnCloseSettings = document.getElementById("btnCloseSettings");
  const btnTheme = document.getElementById("btnTheme");
  const btnMotion = document.getElementById("btnMotion");
  const fontSize = document.getElementById("fontSize");
  const accent = document.getElementById("accent");

  // Pause modal
  const pauseModal = document.getElementById("pauseModal");
  const btnClosePause = document.getElementById("btnClosePause");
  const btnSnooze = document.getElementById("btnSnooze");

  // Mobile nav
  const leftPane = document.getElementById("leftPane");
  const rightPane = document.getElementById("rightPane");
  const navExplore = document.getElementById("navExplore");
  const navDetail = document.getElementById("navDetail");
  const navWork = document.getElementById("navWork");
  const navExport = document.getElementById("navExport");

  // ----------------------------
  // Utils
  // ----------------------------
  const nowISO = () => new Date().toISOString();
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  function escapeHTML(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // minimal markdown (safe): **bold**, *italic*, `code`, links http(s)
  function mdToHTML(s){
    const t = escapeHTML(String(s ?? ""));
    let x = t
      .replace(/`([^`]+)`/g, "<span class='mono'>$1</span>")
      .replace(/\*\*([^*]+)\*\*/g, "<b>$1</b>")
      .replace(/\*([^*]+)\*/g, "<i>$1</i>")
      .replace(/(https?:\/\/[^\s<]+)/g, "<a href='$1' target='_blank' rel='noopener noreferrer'>$1</a>")
      .replace(/\n/g, "<br/>");
    return x;
  }

  function safeJSONparse(txt){
    const trimmed = String(txt || "").trim();
    if(!trimmed) throw new Error("Fichier vide");
    if(trimmed.startsWith("<")) throw new Error("Le fichier ressemble √† du HTML, pas du JSON");
    return JSON.parse(trimmed);
  }

  function lsGet(key, fallback=null){
    try{
      const v = localStorage.getItem(key);
      if(v==null) return fallback;
      return JSON.parse(v);
    }catch(e){
      return fallback;
    }
  }
  function lsSet(key, value){
    try{
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    }catch(e){
      return false;
    }
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1200);
  }

  function pickContact(fields){
    const f = fields || {};
    const phone = f.phone || f.telephone || f.tel || f.gsm || "";
    const email = f.email || f.mail || f.courriel || "";
    const url   = f.url || f.website || f.site_web || f.site || "";
    const address = f.address || f.adresse || "";
    const commune = f.commune || f.localite || f.ville || "";
    return { phone, email, url, address, commune };
  }

  // ----------------------------
  // Detect + normalize formats
  // ----------------------------
  function normalizeNYXO(obj){
    // expected: zones/entities/links/tasks/sources (some may be missing)
    const meta = obj.meta || {};
    const sources = obj.sources || [];
    const zones = Array.isArray(obj.zones) ? obj.zones : [];
    const entities = Array.isArray(obj.entities) ? obj.entities : [];
    const links = Array.isArray(obj.links) ? obj.links : [];
    const tasks = Array.isArray(obj.tasks) ? obj.tasks : [];

    // Normalize entity shape for UI
    const eMap = new Map();
    for(const e of entities){
      if(!e || !e.id) continue;
      const name = e.display?.masked_name || e.display?.name || e.name || e.title || "Sans nom";
      eMap.set(e.id, {
        id: e.id,
        type: e.type || "service",
        zone: e.zone || null,
        x: typeof e.x==="number" ? e.x : 0,
        y: typeof e.y==="number" ? e.y : 0,
        display: {
          masked_name: name,
          summary: e.display?.summary || "",
          real_name: e.display?.real_name ?? null,
        },
        tags: Array.isArray(e.tags) ? e.tags : [],
        status: e.status || "unverified",
        confidence: (typeof e.confidence==="number" ? e.confidence : null),
        fields: (e.fields && typeof e.fields==="object") ? e.fields : {},
        evidence: Array.isArray(e.evidence) ? e.evidence : [],
        layer: e.layer || null,
      });
    }

    // Normalize links (support {from,to,type})
    const lNorm = [];
    for(const l of links){
      if(!l) continue;
      const from = l.from || l.source || l.a || null;
      const to   = l.to || l.target || l.b || null;
      if(!from || !to) continue;
      lNorm.push({
        id: l.id || (from+"__"+(l.type||"link")+"__"+to),
        from, to,
        type: l.type || "link",
        label: l.label || "",
        evidence: Array.isArray(l.evidence) ? l.evidence : [],
      });
    }

    return {
      meta: Object.assign({ schema: "nyxo" }, meta),
      sources,
      zones,
      entities: Array.from(eMap.values()),
      links: lNorm,
      tasks
    };
  }

  function normalizeLDLexport(obj){
    // Best-effort: detect common "workspace export" shapes
    // Accept:
    // - {nodes:[...], edges:[...]} or {entities:[...], links:[...]} or {graph:{nodes,edges}}
    const g = obj.graph && typeof obj.graph==="object" ? obj.graph : obj;
    const nodes = g.nodes || g.entities || [];
    const edges = g.edges || g.links || [];
    if(!Array.isArray(nodes) || nodes.length===0) throw new Error("Format non reconnu (pas de nodes/entities)");

    const entities = nodes.map(n => {
      const id = n.id || n.uid || n.key;
      if(!id) return null;
      const name = n.name || n.title || n.label || n.display?.masked_name || "Sans nom";
      return {
        id,
        type: n.type || n.kind || "service",
        zone: n.zone || null,
        x: typeof n.x==="number" ? n.x : 0,
        y: typeof n.y==="number" ? n.y : 0,
        display: {
          masked_name: name,
          summary: n.summary || n.description || n.display?.summary || "",
          real_name: null
        },
        tags: Array.isArray(n.tags) ? n.tags : [],
        status: n.status || "unverified",
        confidence: (typeof n.confidence==="number" ? n.confidence : null),
        fields: (n.fields && typeof n.fields==="object") ? n.fields : (n.data && typeof n.data==="object" ? n.data : {}),
        evidence: Array.isArray(n.evidence) ? n.evidence : [],
        layer: n.layer || null,
      };
    }).filter(Boolean);

    const links = [];
    for(const e of edges){
      const from = e.from || e.source || e.a;
      const to = e.to || e.target || e.b;
      if(!from || !to) continue;
      links.push({
        id: e.id || (from+"__"+(e.type||"link")+"__"+to),
        from, to,
        type: e.type || "link",
        label: e.label || "",
        evidence: Array.isArray(e.evidence) ? e.evidence : [],
      });
    }

    return {
      meta: { schema:"ldl_export", imported_at: nowISO() },
      sources: [],
      zones: [],
      entities,
      links,
      tasks: Array.isArray(obj.tasks) ? obj.tasks : []
    };
  }

  function normalizeAny(obj){
    // Heuristics:
    if(obj && Array.isArray(obj.entities) && (obj.meta || obj.zones || obj.links || obj.tasks)){
      return normalizeNYXO(obj);
    }
    if(obj && (obj.nodes || obj.edges || obj.graph)){
      return normalizeLDLexport(obj);
    }
    // fallback: try nyxo first
    try{ return normalizeNYXO(obj); }catch(e){}
    return normalizeLDLexport(obj);
  }

  // ----------------------------
  // Overlay application
  // ----------------------------
  function applyOverlay(entity){
    const id = entity.id;
    const o = overlay || {};
    const e = JSON.parse(JSON.stringify(entity));

    // status override
    if(o.status && o.status[id]) e.status = o.status[id];

    // tags add/remove (stored as full set for simplicity)
    if(o.tags && o.tags[id]) e.tags = o.tags[id].slice();

    // notes
    e._note = (o.notes && o.notes[id]) ? o.notes[id] : "";

    // fields edits: shallow merge
    if(o.edits && o.edits[id]){
      e.fields = Object.assign({}, e.fields || {}, o.edits[id]);
    }

    return e;
  }

  // ----------------------------
  // History nav
  // ----------------------------
  function pushHistory(id){
    if(!id) return;
    // if same as current, ignore
    if(history.idx >= 0 && history.list[history.idx] === id) return;
    // cut forward
    history.list = history.list.slice(0, history.idx + 1);
    history.list.push(id);
    history.idx = history.list.length - 1;
    lsSet(LS.HISTORY, history);
    updateNavButtons();
  }
  function goBack(){
    if(history.idx > 0){
      history.idx--;
      lsSet(LS.HISTORY, history);
      updateNavButtons();
      selectById(history.list[history.idx], {push:false, scroll:true});
    }
  }
  function goForward(){
    if(history.idx < history.list.length - 1){
      history.idx++;
      lsSet(LS.HISTORY, history);
      updateNavButtons();
      selectById(history.list[history.idx], {push:false, scroll:true});
    }
  }
  function updateNavButtons(){
    btnBack.disabled = !(history.idx > 0);
    btnForward.disabled = !(history.idx < history.list.length - 1);
  }

  // ----------------------------
  // Render monitor + detail
  // ----------------------------
  let selectedId = null;

  function typeLabel(t){
    const m = {
      lieu_de_lien:"Lieu de lien",
      ssm:"Service sant√© mentale",
      hotline:"Ligne d‚Äô√©coute",
      hopital:"H√¥pital / urgences",
      equipe_mobile:"√âquipe mobile",
      spad:"SPAD",
      education_permanente:"√âducation permanente",
      service:"Service",
    };
    return m[t] || t || "‚Äî";
  }

  function statusDot(s){
    if(s==="verified") return "green";
    if(s==="rejected") return "red";
    return "";
  }

  function computeChips(){
    if(!G) return;
    const ents = G.entities;
    const counts = {};
    for(const e of ents){
      counts[e.type] = (counts[e.type]||0)+1;
    }
    const items = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,8);
    chips.innerHTML = items.map(([t,c]) => `<span class="chip">${escapeHTML(typeLabel(t))} ‚Ä¢ ${c}</span>`).join("");
  }

  function filterEntities(){
    if(!G) return [];
    const qq = (q.value||"").trim().toLowerCase();
    const t = typeSel.value || "";
    const out = [];
    for(const raw of G.entities){
      const e = applyOverlay(raw);
      if(t && e.type !== t) continue;
      if(qq){
        const hay = (e.display.masked_name+" "+(e.display.summary||"")+" "+JSON.stringify(e.fields||{})).toLowerCase();
        if(!hay.includes(qq)) continue;
      }
      out.push(e);
    }
    // role-aware ordering (simple)
    out.sort((a,b)=>a.display.masked_name.localeCompare(b.display.masked_name, "fr"));
    return out;
  }

  function renderList(){
    if(!G){
      list.innerHTML = "";
      countHint.textContent = "0";
      return;
    }
    const items = filterEntities();
    countHint.textContent = items.length.toString();
    list.innerHTML = items.slice(0, 500).map(e => {
      const active = e.id===selectedId ? "active" : "";
      const dot = statusDot(e.status);
      const {commune} = pickContact(e.fields);
      const sub = commune ? `${typeLabel(e.type)} ‚Ä¢ ${commune}` : `${typeLabel(e.type)}`;
      const meta = e.id ? e.id : "";
      return `
        <div class="item ${active}" data-id="${escapeHTML(e.id)}">
          <div class="dot ${dot}"></div>
          <div style="min-width:0">
            <div class="ititle">${escapeHTML(e.display.masked_name)}</div>
            <div class="isub">${escapeHTML(sub)}</div>
            <div class="metaLine">${escapeHTML(meta)}</div>
          </div>
        </div>
      `;
    }).join("") + (items.length>500 ? `<div class="tiny muted">Affichage limit√© √† 500 r√©sultats. Affine la recherche.</div>`:"");

    // Click handlers
    list.querySelectorAll(".item").forEach(el=>{
      el.addEventListener("click", ()=>{
        selectById(el.getAttribute("data-id"), {push:true, scroll:false});
        // mobile: jump to detail
        if(window.matchMedia("(max-width: 899px)").matches){
          activatePane("right");
        }
      });
    });
  }

  function renderDetail(e){
    if(!e){
      detailHint.textContent = "S√©lectionne un √©l√©ment";
      detail.innerHTML = `<div class="warnbox"><b>Astuce :</b> s√©lectionne un √©l√©ment dans le monitor.</div>`;
      return;
    }
    detailHint.textContent = typeLabel(e.type);

    const {phone,email,url,address,commune} = pickContact(e.fields);
    const pinned = pins.includes(e.id);

    const ev = Array.isArray(e.evidence) ? e.evidence : [];
    const evHTML = ev.length ? `
      <div class="divider"></div>
      <div class="tiny muted"><b>Sources (traces)</b></div>
      <div class="tiny mono">${escapeHTML(JSON.stringify(ev, null, 2))}</div>
    ` : "";

    const note = e._note || "";
    const tags = Array.isArray(e.tags) ? e.tags : [];

    const kvRows = [];
    const addKV = (k,v) => {
      if(!v) return;
      kvRows.push(`<div class="k">${escapeHTML(k)}</div><div class="v">${mdToHTML(v)}</div>`);
    };

    addKV("Commune", commune);
    addKV("Adresse", address);
    addKV("T√©l√©phone", phone);
    addKV("Email", email);
    addKV("Site", url ? `<a href="${escapeHTML(url)}" target="_blank" rel="noopener noreferrer">${escapeHTML(url)}</a>` : "");
    addKV("R√©sum√©", e.display.summary || "");
    // show selected useful fields if present
    const f = e.fields || {};
    addKV("Public", f.public_cible || f.public || "");
    addKV("Missions", f.missions || f.description || f.objet || "");
    addKV("Langues", f.langues || f.langues_parlees || "");
    addKV("Co√ªt", f.tarifs || f.aspects_financiers_et_tarifs || "");
    addKV("Acc√®s", f.conditions_acces || "");

    detail.innerHTML = `
      <div class="titlebar">
        <div style="min-width:0">
          <h3>${escapeHTML(e.display.masked_name)}</h3>
          <div class="small">
            <span class="mono">${escapeHTML(e.id)}</span> ‚Ä¢
            <span class="muted">${escapeHTML(typeLabel(e.type))}</span> ‚Ä¢
            <span class="muted">statut: <b>${escapeHTML(e.status||"unverified")}</b></span>
          </div>
        </div>
        <div class="actions">
          <button class="ghost" id="actCall" ${phone ? "" : "disabled"} title="Appeler">üìû</button>
          <button class="ghost" id="actMail" ${email ? "" : "disabled"} title="Envoyer email">‚úâÔ∏è</button>
          <button class="ghost" id="actWeb" ${url ? "" : "disabled"} title="Ouvrir site">üåê</button>
          <button class="ghost" id="actMap" ${(address||commune) ? "" : "disabled"} title="Ouvrir carte">üó∫Ô∏è</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="chips">
        ${tags.map(t=>`<span class="chip">${escapeHTML(t)}</span>`).join("")}
        ${pinned ? `<span class="chip">üìå √©pingl√©</span>` : ``}
      </div>

      <div class="kvs">${kvRows.join("") || `<div class="tiny muted">Pas d‚Äôinfo affichable pour le moment.</div>`}</div>

      <div class="divider"></div>

      <div class="stack">
        <div class="tiny muted"><b>Note de travail</b> (local)</div>
        <textarea id="noteBox" placeholder="√âcris une note (local, exportable)‚Ä¶">${escapeHTML(note)}</textarea>

        <div class="row3">
          <button class="primary" id="saveNote">üíæ Enregistrer note</button>
          <button class="ghost" id="setVerified">‚úÖ Marquer v√©rifi√©</button>
        </div>

        <div class="row3">
          <input id="tagInput" placeholder="Ajouter un tag (ex: urgence, sans rdv, FR/NL‚Ä¶)"/>
          <button id="addTag">‚ûï Tag</button>
        </div>

        <div class="row3">
          <button class="ghost" id="removeTag">‚ûñ Retirer tag</button>
          <button class="bad" id="markRejected">‚õî Marquer √† corriger</button>
        </div>
      </div>

      ${evHTML}
    `;

    // Actions
    const actCall = document.getElementById("actCall");
    const actMail = document.getElementById("actMail");
    const actWeb  = document.getElementById("actWeb");
    const actMap  = document.getElementById("actMap");

    if(actCall) actCall.addEventListener("click", ()=>{ if(phone) window.location.href = "tel:" + phone.replace(/\s+/g,""); });
    if(actMail) actMail.addEventListener("click", ()=>{ if(email) window.location.href = "mailto:" + email; });
    if(actWeb)  actWeb.addEventListener("click", ()=>{ if(url) window.open(url, "_blank", "noopener,noreferrer"); });
    if(actMap)  actMap.addEventListener("click", ()=>{
      const query = encodeURIComponent([address, commune, "Bruxelles"].filter(Boolean).join(", "));
      window.open("https://www.google.com/maps/search/?api=1&query=" + query, "_blank", "noopener,noreferrer");
    });

    // Note saving
    const noteBox = document.getElementById("noteBox");
    const saveNote = document.getElementById("saveNote");
    if(saveNote) saveNote.addEventListener("click", ()=>{
      const val = (noteBox.value || "").trim();
      overlay.notes[e.id] = val;
      persistOverlay();
      toast("Note enregistr√©e.");
    });

    // Status
    const setVerified = document.getElementById("setVerified");
    if(setVerified) setVerified.addEventListener("click", ()=>{
      overlay.status[e.id] = "verified";
      persistOverlay();
      selectById(e.id, {push:false, scroll:false});
      toast("Marqu√© comme v√©rifi√©.");
    });
    const markRejected = document.getElementById("markRejected");
    if(markRejected) markRejected.addEventListener("click", ()=>{
      overlay.status[e.id] = "rejected";
      persistOverlay();
      selectById(e.id, {push:false, scroll:false});
      toast("Marqu√© √† corriger.");
    });

    // Tags
    const tagInput = document.getElementById("tagInput");
    const addTag = document.getElementById("addTag");
    const removeTag = document.getElementById("removeTag");
    if(addTag) addTag.addEventListener("click", ()=>{
      const t = (tagInput.value||"").trim();
      if(!t) return;
      const current = overlay.tags[e.id] || e.tags || [];
      const set = Array.from(new Set(current.concat([t])));
      overlay.tags[e.id] = set;
      persistOverlay();
      selectById(e.id, {push:false, scroll:false});
      toast("Tag ajout√©.");
    });
    if(removeTag) removeTag.addEventListener("click", ()=>{
      const t = (tagInput.value||"").trim();
      if(!t) return;
      const current = overlay.tags[e.id] || e.tags || [];
      overlay.tags[e.id] = current.filter(x=>x!==t);
      persistOverlay();
      selectById(e.id, {push:false, scroll:false});
      toast("Tag retir√©.");
    });
  }

  function findEntity(id){
    if(!G) return null;
    const raw = G.entities.find(x=>x.id===id);
    if(!raw) return null;
    return applyOverlay(raw);
  }

  function selectById(id, opts={push:true, scroll:false}){
    if(!id) return;
    const e = findEntity(id);
    if(!e) return;
    selectedId = id;
    if(opts.push) pushHistory(id);
    renderList();
    renderDetail(e);
    if(opts.scroll){
      const el = list.querySelector(`.item[data-id="${CSS.escape(id)}"]`);
      if(el) el.scrollIntoView({block:"center"});
    }
  }

  // ----------------------------
  // Import
  // ----------------------------
  function setPill(text, ok=false){
    pillState.textContent = text;
    pillState.style.borderColor = ok ? "rgba(98,246,167,.35)" : "rgba(255,255,255,.10)";
  }

  function persistDataset(){
    // Store raw + normalized (best-effort). If too big, still try overlay only.
    const ok1 = lsSet(LS.DATA, RAW);
    const ok2 = lsSet(LS.SESSION, { started, role, selectedId, savedAt: Date.now() });
    if(!ok1){
      // RAW too big: store only normalized essentials
      lsSet(LS.DATA, { meta: RAW?.meta || {}, entities: RAW?.entities || [], links: RAW?.links || [], zones: RAW?.zones || [] });
    }
    if(!ok2){ /* ignore */ }
  }

  function persistOverlay(){
    lsSet(LS.OVERLAY, overlay);
  }
  function persistPins(){
    lsSet(LS.PINS, pins);
  }

  async function readFileAsText(file){
    return await new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onerror = () => reject(r.error || new Error("Lecture impossible"));
      r.onload = () => resolve(String(r.result||""));
      r.readAsText(file);
    });
  }

  async function importObject(obj, origin){
    RAW = obj;
    G = normalizeAny(obj);
    // Overlay & pins keep local; do not wipe unless incompatible
    persistDataset();

    setPill(`üì¶ Dataset charg√© (${origin})`, true);
    computeChips();
    renderList();
    // keep selection if exists
    if(selectedId && findEntity(selectedId)) renderDetail(findEntity(selectedId));
    else renderDetail(null);

    toast("Import OK.");
  }

  async function importFile(file){
    try{
      setPill("üì¶ Import‚Ä¶");
      const txt = await readFileAsText(file);
      const obj = safeJSONparse(txt);
      await importObject(obj, "fichier local");
    }catch(err){
      const msg = (err && err.message) ? err.message : String(err);
      toast("Import erreur: " + msg, true);
      setPill("üì¶ Import erreur");
    }
  }

  async function tryFetch(){
    // Only works when served through http(s)
    try{
      setPill("üì¶ Auto-chargement‚Ä¶");
      const res = await fetch("nyxo-ULTIMATE-brussels-strict.json", {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP " + res.status + " (JSON introuvable)");
      const obj = await res.json();
      await importObject(obj, "auto (m√™me dossier)");
    }catch(err){
      toast("Impossible d‚Äôauto-charger. (Failed to fetch / CORS en file://)", true);
      setPill("üì¶ Auto-chargement KO");
    }
  }

  // Drop zone
  function wireDrop(){
    ["dragenter","dragover"].forEach(evt => drop.addEventListener(evt, (e)=>{
      e.preventDefault(); e.stopPropagation();
      drop.classList.add("drag");
    }));
    ["dragleave","drop"].forEach(evt => drop.addEventListener(evt, (e)=>{
      e.preventDefault(); e.stopPropagation();
      drop.classList.remove("drag");
    }));
    drop.addEventListener("drop", async (e)=>{
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(!f) return;
      await importFile(f);
    });
  }

  // ----------------------------
  // Export (no embedded data in code; export uses current loaded data)
  // ----------------------------
  function buildExport(){
    if(!G) throw new Error("Aucun dataset charg√©");
    const exportObj = {
      meta: {
        dataset: "nyxo_workspace_export",
        exported_at: nowISO(),
        role,
        note: "Export contient dataset normalis√© + overlay (notes/tags/status/edits) + historique + pins."
      },
      base: G,
      overlay,
      pins,
      history,
      selectedId
    };
    return exportObj;
  }

  function doExport(){
    try{
      const obj = buildExport();
      const text = JSON.stringify(obj, null, 2);
      const ts = new Date().toISOString().slice(0,19).replaceAll(":","-");
      downloadText(`nyxo-bruxelles-export-${ts}.json`, text);
      lsSet(LS.LAST_EXPORT_AT, Date.now());
      toast("Export OK.");
    }catch(err){
      toast("Export erreur: " + (err?.message || err), true);
    }
  }

  async function doCopy(){
    try{
      const obj = buildExport();
      const text = JSON.stringify(obj, null, 2);
      await navigator.clipboard.writeText(text);
      toast("JSON copi√©.");
    }catch(err){
      toast("Copie impossible (permissions). Utilise EXPORT.", true);
    }
  }

  function doReset(){
    const ok = confirm("Reset local : effacer dataset, overlay, historique, pins ?\n\nTu as export√© ?");
    if(!ok) return;
    for(const k of Object.values(LS)){
      try{ localStorage.removeItem(k); }catch(e){}
    }
    RAW=null; G=null;
    overlay = { edits:{}, notes:{}, tags:{}, status:{} };
    pins = [];
    history = { list:[], idx:-1 };
    selectedId = null;
    started = false;
    setPill("üì¶ Aucun dataset");
    renderList();
    renderDetail(null);
    toast("Reset OK.");
    onboardingHint.textContent="1/3";
  }

  // ----------------------------
  // Blinking Export (every 3 minutes)
  // ----------------------------
  function scheduleExportBlink(){
    const EVERY = 3 * 60 * 1000;
    const DURATION = 11 * 1000;
    function blink(){
      btnExport.classList.add("blink-purple");
      setTimeout(()=>btnExport.classList.remove("blink-purple"), DURATION);
    }
    // immediate soft blink if never exported
    const last = lsGet(LS.LAST_EXPORT_AT, 0);
    if(!last) setTimeout(blink, 2500);
    setInterval(blink, EVERY);
  }

  // ----------------------------
  // Pause (every 50 minutes)
  // ----------------------------
  let pauseTimer = null;
  function openPause(){
    pauseModal.dataset.open="1";
    pauseModal.setAttribute("aria-hidden","false");
    btnPause.classList.add("blink-green");
  }
  function closePause(){
    pauseModal.dataset.open="0";
    pauseModal.setAttribute("aria-hidden","true");
    btnPause.classList.remove("blink-green");
  }
  function schedulePause(){
    if(pauseTimer) clearTimeout(pauseTimer);
    pauseTimer = setTimeout(openPause, 50 * 60 * 1000);
  }

  // ----------------------------
  // Mobile navigation
  // ----------------------------
  function setNavActive(which){
    [navExplore, navDetail, navWork, navExport].forEach(b=>b.classList.remove("active"));
    if(which==="left") navExplore.classList.add("active");
    if(which==="right") navDetail.classList.add("active");
    if(which==="work") navWork.classList.add("active");
    if(which==="export") navExport.classList.add("active");
  }
  function activatePane(which){
    if(window.matchMedia("(min-width: 900px)").matches) return; // desktop shows both
    leftPane.dataset.active = (which==="left") ? "1" : "0";
    rightPane.dataset.active = (which!=="left") ? "1" : "0";
    setNavActive(which);
    // For "work"/"export", we still show right pane (detail+export panel)
    if(which==="work" || which==="export"){
      leftPane.dataset.active="0";
      rightPane.dataset.active="1";
      setNavActive(which);
      // scroll export into view if needed
      if(which==="export"){
        setTimeout(()=>btnExport.scrollIntoView({block:"center"}), 150);
      }
    }
  }

  // ----------------------------
  // Settings
  // ----------------------------
  function openSettings(){
    settingsModal.dataset.open="1";
    settingsModal.setAttribute("aria-hidden","false");
  }
  function closeSettings(){
    settingsModal.dataset.open="0";
    settingsModal.setAttribute("aria-hidden","true");
  }

  function applySettings(s){
    const theme = s.theme || "dark";
    const reduce = s.reduceMotion ? "1" : "0";
    const fs = clamp(Number(s.fontSize||16), 14, 20);
    const hue = clamp(Number(s.accentHue||270), 0, 360);

    app.dataset.theme = theme;
    app.dataset.reduceMotion = reduce;
    document.documentElement.style.setProperty("--fs", fs + "px");
    // hue -> accent mauve-ish via HSL
    document.documentElement.style.setProperty("--accent", `hsl(${hue} 95% 75%)`);
    document.documentElement.style.setProperty("--focus", `0 0 0 3px hsla(${hue} 95% 75% / .22)`);

    btnTheme.textContent = theme==="dark" ? "üåó Th√®me : sombre" : "üåó Th√®me : clair";
    btnMotion.textContent = reduce==="1" ? "ü´ß Animations : OFF" : "ü´ß Animations : ON";
    fontSize.value = fs;
    accent.value = hue;
  }

  function saveSettings(patch){
    const cur = lsGet(LS.SETTINGS, {theme:"dark", reduceMotion:false, fontSize:16, accentHue:270});
    const next = Object.assign({}, cur, patch);
    lsSet(LS.SETTINGS, next);
    applySettings(next);
  }

  // ----------------------------
  // Toast
  // ----------------------------
  let toastEl = null;
  let toastTimer = null;
  function toast(msg, bad=false){
    if(!toastEl){
      toastEl = document.createElement("div");
      toastEl.style.position="fixed";
      toastEl.style.left="50%";
      toastEl.style.bottom="86px";
      toastEl.style.transform="translateX(-50%)";
      toastEl.style.padding=".7rem .85rem";
      toastEl.style.borderRadius="14px";
      toastEl.style.border="1px solid rgba(255,255,255,.10)";
      toastEl.style.background="rgba(10,12,18,.85)";
      toastEl.style.backdropFilter="blur(10px)";
      toastEl.style.color="var(--fg)";
      toastEl.style.boxShadow="var(--shadow)";
      toastEl.style.zIndex="120";
      toastEl.style.maxWidth="92vw";
      toastEl.style.textAlign="center";
      document.body.appendChild(toastEl);
    }
    toastEl.textContent = msg;
    toastEl.style.borderColor = bad ? "rgba(255,107,107,.40)" : "rgba(98,246,167,.30)";
    toastEl.style.opacity="1";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ toastEl.style.opacity="0"; }, 2600);
  }

  // ----------------------------
  // Pins
  // ----------------------------
  function togglePin(){
    if(!selectedId) return;
    const idx = pins.indexOf(selectedId);
    if(idx>=0) pins.splice(idx,1);
    else pins.unshift(selectedId);
    pins = pins.slice(0, 40);
    persistPins();
    toast(idx>=0 ? "D√©s√©pingl√©." : "√âpingl√©.");
  }

  // ----------------------------
  // Onboarding start
  // ----------------------------
  function startApp(){
    started = true;
    role = roleSel.value;
    lsSet(LS.SESSION, { started, role, selectedId, savedAt: Date.now() });
    onboardingHint.textContent = "OK";
    toast("D√©marr√©.");
    // ensure panes show
    if(window.matchMedia("(max-width: 899px)").matches){
      activatePane("left");
    }else{
      leftPane.dataset.active="1";
      rightPane.dataset.active="1";
    }
  }

  // ----------------------------
  // Wire events
  // ----------------------------
  function wire(){
    btnPick.addEventListener("click", ()=>fileInput.click());
    fileInput.addEventListener("change", async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      await importFile(f);
      e.target.value = "";
    });
    btnTryFetch.addEventListener("click", tryFetch);
    wireDrop();

    roleSel.addEventListener("change", ()=>{ onboardingHint.textContent="3/3"; });
    btnStart.addEventListener("click", startApp);

    q.addEventListener("input", ()=>renderList());
    typeSel.addEventListener("change", ()=>renderList());

    btnBack.addEventListener("click", goBack);
    btnForward.addEventListener("click", goForward);
    btnPin.addEventListener("click", togglePin);
    btnClearSelection.addEventListener("click", ()=>{
      selectedId=null;
      renderList();
      renderDetail(null);
    });

    btnExport.addEventListener("click", doExport);
    btnCopy.addEventListener("click", doCopy);
    btnReset.addEventListener("click", doReset);

    btnPause.addEventListener("click", openPause);
    btnClosePause.addEventListener("click", closePause);
    btnSnooze.addEventListener("click", ()=>{
      closePause();
      schedulePause();
      toast("OK. Prochain rappel dans 50 min.");
    });

    // Settings
    btnSettings.addEventListener("click", openSettings);
    btnCloseSettings.addEventListener("click", closeSettings);
    settingsModal.addEventListener("click", (e)=>{ if(e.target===settingsModal) closeSettings(); });

    btnTheme.addEventListener("click", ()=>{
      const cur = lsGet(LS.SETTINGS, {theme:"dark"});
      saveSettings({ theme: cur.theme==="dark" ? "light" : "dark" });
    });
    btnMotion.addEventListener("click", ()=>{
      const cur = lsGet(LS.SETTINGS, {reduceMotion:false});
      saveSettings({ reduceMotion: !cur.reduceMotion });
    });
    fontSize.addEventListener("input", ()=>saveSettings({ fontSize: Number(fontSize.value) }));
    accent.addEventListener("input", ()=>saveSettings({ accentHue: Number(accent.value) }));

    // Mobile nav
    navExplore.addEventListener("click", ()=>activatePane("left"));
    navDetail.addEventListener("click", ()=>activatePane("right"));
    navWork.addEventListener("click", ()=>activatePane("work"));
    navExport.addEventListener("click", ()=>activatePane("export"));

    // Close modals with ESC
    window.addEventListener("keydown", (e)=>{
      if(e.key==="Escape"){
        closeSettings();
        closePause();
      }
    });

    // Resize: ensure panes on desktop
    window.addEventListener("resize", ()=>{
      if(window.matchMedia("(min-width: 900px)").matches){
        leftPane.dataset.active="1";
        rightPane.dataset.active="1";
      }
    });
  }

  // ----------------------------
  // Boot: restore previous session if any (NO embedded data)
  // ----------------------------
  function boot(){
    // Settings
    const s = lsGet(LS.SETTINGS, {theme:"dark", reduceMotion:false, fontSize:16, accentHue:270});
    applySettings(s);

    // Overlay, pins, history
    overlay = lsGet(LS.OVERLAY, overlay) || overlay;
    pins = lsGet(LS.PINS, pins) || pins;
    history = lsGet(LS.HISTORY, history) || history;
    updateNavButtons();

    // Session
    const sess = lsGet(LS.SESSION, null);
    if(sess && typeof sess==="object"){
      role = sess.role || role;
      roleSel.value = role;
      started = !!sess.started;
      selectedId = sess.selectedId || null;
      onboardingHint.textContent = started ? "OK" : "1/3";
    }

    // Dataset
    const saved = lsGet(LS.DATA, null);
    if(saved){
      try{
        RAW = saved;
        G = normalizeAny(saved);
        setPill("üì¶ Dataset charg√© (session)", true);
        computeChips();
        renderList();
        if(selectedId && findEntity(selectedId)){
          renderDetail(findEntity(selectedId));
        }else{
          renderDetail(null);
        }
      }catch(e){
        setPill("üì¶ Session corrompue");
      }
    }else{
      setPill("üì¶ Aucun dataset");
    }

    // Start pause schedule
    schedulePause();

    // Export blink
    scheduleExportBlink();

    // Initial chips
    if(G) computeChips();
  }

  // Persist overlay whenever it changes
  function persistOverlay(){
    lsSet(LS.OVERLAY, overlay);
  }

  // ----------------------------
  // GO
  // ----------------------------
  wire();
  boot();

  // Public-ish helpers for debugging (optional)
  window.__nyxo = {
    importObject,
    normalizeAny,
    getState: ()=>({RAW, G, overlay, pins, history, selectedId, role, started})
  };

})();
</script>
</body>
</html>
